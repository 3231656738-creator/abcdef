<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Find Your Inner Compass — 探索你的人格罗盘</title>
    <link rel="preconnect" href="https://fonts.loli.net">
    <link rel="preconnect" href="https://gstatic.loli.net" crossorigin>
    <link rel="preload"
        href="https://fonts.loli.net/css2?family=Cormorant+Garamond:wght@400;600;700&family=Playfair+Display:wght@400;600;700&family=Noto+Serif+SC:wght@400;700&display=swap"
        as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript>
        <link
            href="https://fonts.loli.net/css2?family=Cormorant+Garamond:wght@400;600;700&family=Playfair+Display:wght@400;600;700&family=Noto+Serif+SC:wght@400;700&display=swap"
            rel="stylesheet">
    </noscript>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lxgw-wenkai-screen-web/style.css" />
    <link rel="preload"
        href="https://fonts.loli.net/css2?family=Pinyon+Script&family=ZCOOL+QingKe+HuangYou&display=swap" as="style"
        onload="this.onload=null;this.rel='stylesheet'">
    <noscript>
        <link href="https://fonts.loli.net/css2?family=Pinyon+Script&family=ZCOOL+QingKe+HuangYou&display=swap"
            rel="stylesheet">
    </noscript>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- html2canvas loaded on demand -->
    <!-- ═══ Global Pet Container (Fixed Bottom) ═══ -->
    <div class="pet-container">
        <!-- Left: Cat (Enhanced) -->
        <div class="pet-icon-wrapper pet-left" onclick="petInteract(this, event)">
            <svg class="pet-svg" viewBox="0 0 200 200">
                <defs>
                    <linearGradient id="goldGradDeep" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" style="stop-color:#DAA520;stop-opacity:1" />
                        <stop offset="50%" style="stop-color:#B8860B;stop-opacity:1" />
                        <stop offset="100%" style="stop-color:#8B4500;stop-opacity:1" />
                    </linearGradient>
                    <filter id="dropShadow" x="-20%" y="-20%" width="140%" height="140%">
                        <feGaussianBlur in="SourceAlpha" stdDeviation="3" />
                        <feOffset dx="2" dy="4" result="offsetblur" />
                        <feComponentTransfer>
                            <feFuncA type="linear" slope="0.3" />
                        </feComponentTransfer>
                        <feMerge>
                            <feMergeNode in="offsetblur" />
                            <feMergeNode in="SourceGraphic" />
                        </feMerge>
                    </filter>
                </defs>
                <!-- Shadow -->
                <ellipse cx="100" cy="180" rx="55" ry="10" fill="#000" opacity="0.25" filter="url(#dropShadow)" />
                <!-- Body with Fur Spikes -->
                <path d="M70 170 Q50 170 50 140 Q50 110 80 100 Q100 90 120 100 Q150 110 150 140 Q150 170 130 170 Z"
                    fill="url(#goldGradDeep)" filter="url(#dropShadow)" />
                <!-- Head -->
                <g filter="url(#dropShadow)">
                    <!-- Ears -->
                    <path d="M70 85 L60 40 L90 70 Z" fill="url(#goldGradDeep)" />
                    <path d="M130 85 L140 40 L110 70 Z" fill="url(#goldGradDeep)" />
                    <!-- Face Base -->
                    <ellipse cx="100" cy="95" rx="40" ry="35" fill="url(#goldGradDeep)" />
                    <!-- Cheek Fur -->
                    <path d="M60 95 L50 90 L60 100 L50 105 L62 110 Z" fill="url(#goldGradDeep)" />
                    <path d="M140 95 L150 90 L140 100 L150 105 L138 110 Z" fill="url(#goldGradDeep)" />
                </g>
                <!-- Face Details -->
                <g fill="#2E1A47">
                    <!-- Eyes (Almond) -->
                    <path d="M82 90 Q90 85 98 90 Q90 98 82 90" />
                    <path d="M102 90 Q110 85 118 90 Q110 98 102 90" />
                    <!-- Nose -->
                    <path d="M100 100 L96 96 L104 96 Z" />
                    <!-- Whiskers -->
                    <path d="M75 100 L55 95 M75 105 L55 105 M75 110 L55 115" stroke="#2E1A47" stroke-width="1.5" />
                    <path d="M125 100 L145 95 M125 105 L145 105 M125 110 L145 115" stroke="#2E1A47"
                        stroke-width="1.5" />
                </g>
                <!-- Tail -->
                <path d="M130 160 Q160 150 150 110" fill="none" stroke="url(#goldGradDeep)" stroke-width="8"
                    stroke-linecap="round" class="animate-sway" />
            </svg>
        </div>

        <!-- Right: Dog (Enhanced) -->
        <div class="pet-icon-wrapper pet-right" onclick="petInteract(this, event)">
            <svg class="pet-svg" viewBox="0 0 200 200">
                <!-- Shadow -->
                <ellipse cx="100" cy="180" rx="55" ry="10" fill="#000" opacity="0.25" />
                <!-- Body -->
                <path d="M60 170 Q45 170 45 140 Q45 110 70 100 Q100 85 130 100 Q155 110 155 140 Q155 170 140 170 Z"
                    fill="url(#goldGradDeep)" filter="url(#dropShadow)" />
                <!-- Head -->
                <g filter="url(#dropShadow)">
                    <circle cx="100" cy="85" r="38" fill="url(#goldGradDeep)" />
                    <!-- Droopy Ears -->
                    <path d="M65 75 Q40 75 40 105 Q40 130 60 115 Z" fill="url(#goldGradDeep)" />
                    <path d="M135 75 Q160 75 160 105 Q160 130 140 115 Z" fill="url(#goldGradDeep)" />
                </g>
                <!-- Face Details -->
                <g fill="#2E1A47">
                    <!-- Eyes (Round) -->
                    <circle cx="85" cy="80" r="5" />
                    <circle cx="115" cy="80" r="5" />
                    <!-- Nose -->
                    <ellipse cx="100" cy="92" rx="8" ry="5" />
                    <!-- Mouth -->
                    <path d="M100 97 L100 105 M90 102 Q100 110 110 102" fill="none" stroke="#2E1A47" stroke-width="2.5"
                        stroke-linecap="round" />
                </g>
                <!-- Tail -->
                <path d="M140 150 Q170 130 160 100" fill="none" stroke="url(#goldGradDeep)" stroke-width="8"
                    stroke-linecap="round" class="animate-sway" style="animation-delay: -1s" />
            </svg>
        </div>
    </div>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        fashion: {
                            50: '#fbf9fd',
                            100: '#f5f0fa',
                            200: '#ede4f6',
                            300: '#e0cfee',
                            400: '#cbb0e2',
                            500: '#b088d1',
                            600: '#9566ba',
                            700: '#7d4ea0',
                            800: '#674083',
                            900: '#2e1a47',
                            950: '#1a0b2e',
                        },
                        accent: {
                            gold: '#B8860B', // Deep Quicksand Gold
                            purple: '#8B5CF6', // New Purple
                            champagne: '#E5D1A6',
                            bronze: '#9C7C38'
                        }
                    },
                    fontFamily: {
                        'display': ['"Playfair Display"', 'serif'],
                        'body': ['"Cormorant Garamond"', 'serif'],
                        'script': ['"Pinyon Script"', 'cursive'],
                        'serif-cn': ['"Noto Serif SC"', 'serif'],
                        'artistic': ['"LXGW WenKai Screen"', '"Noto Serif SC"', 'serif'],
                        'cute': ['"ZCOOL QingKe HuangYou"', 'cursive'],
                    },
                    animation: {
                        'slow-spin': 'spin 12s linear infinite',
                        'float': 'float 6s ease-in-out infinite',
                        'sway': 'sway 3s ease-in-out infinite',
                        'blink': 'blink 4s infinite',
                        'bounce-pet': 'bouncePet 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275)',
                    },
                    keyframes: {
                        sway: {
                            '0%, 100%': { transform: 'rotate(-5deg)' },
                            '50%': { transform: 'rotate(5deg)' },
                        },
                        blink: {
                            '0%, 96%': { transform: 'scaleY(1)' },
                            '98%': { transform: 'scaleY(0.1)' },
                            '100%': { transform: 'scaleY(1)' },
                        },
                        bouncePet: {
                            '0%, 100%': { transform: 'translateY(0) scale(1)' },
                            '50%': { transform: 'translateY(-20px) scale(1.1)' },
                        }
                    }
                }
            }
        }
    </script>
    <style>
        /* ═══ Global & Reset ═══ */
        :root {
            --violet-deep: #2E1A47;
            --violet-mid: #8B5CF6;
            --gold-primary: #B8860B;
            /* Deep Quicksand Gold */
            --gold-light: #DAA520;
            --paper-bg: #F5F0EB;
            /* Warm Grey Beige */
            --dark-overlay: rgba(20, 20, 25, 0.4);
            --glass-border: rgba(184, 134, 11, 0.2);
            --glass-bg: rgba(46, 26, 71, 0.3);
        }

        /* ═══ Letter Interface ═══ */
        .letter-paper {
            background-color: #F0E6D2;
            /* Wood/Parchment color */
            color: #2E1A47;
            /* Wood texture noise */
            background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.12'/%3E%3C/svg%3E");
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3), inset 0 0 60px rgba(139, 92, 246, 0.05);
            border: 1px solid #E5D1A6;
            position: relative;
            transform-style: preserve-3d;
        }

        /* Typography Override for Letter */
        .letter-content {
            font-family: 'Noto Serif SC', 'Georgia', serif;
            line-height: 1.8;
            /* Deep Flowing Gold (Antique Bronze/Dark Gold) */
            color: #B8860B;
            /* Slight shadow for readability on wood background */
            text-shadow: 0 1px 0 rgba(255, 255, 255, 0.4);
            font-weight: 600;
            /* Increased weight for readability */
        }

        .title-metal {
            background: linear-gradient(135deg, #B8860B 0%, #DAA520 50%, #8B4500 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            filter: drop-shadow(0 0 3px #B8860B);
            position: relative;
        }

        /* ═══ Pet Container & Positioning ═══ */
        .pet-container {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 120px;
            z-index: 90;
            /* Below modals (usually 100+), above content */
            pointer-events: none;
            /* Allow clicks to pass through empty areas */
            transition: opacity 0.3s ease;
            /* Smart display transition */
        }

        .pet-container.hide-pets {
            opacity: 0;
            pointer-events: none;
        }

        .pet-icon-wrapper {
            position: absolute;
            bottom: 8%;
            /* 5-10% height as requested */
            width: 100px;
            /* Increased size for detail */
            height: 100px;
            cursor: pointer;
            pointer-events: auto;
            transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            filter: drop-shadow(0 4px 6px rgba(184, 134, 11, 0.3));
            /* Deep gold shadow */
        }

        /* 
           Position: Center bottom, 60% gap.
           Left center at 20% width. Right center at 80% width.
        */
        .pet-left {
            left: 20%;
            transform: translateX(-50%);
        }

        .pet-right {
            right: 20%;
            transform: translateX(50%);
        }

        .pet-left:hover {
            transform: translateX(-50%) scale(1.1) translateY(-5px);
            filter: drop-shadow(0 0 15px rgba(184, 134, 11, 0.6));
        }

        .pet-right:hover {
            transform: translateX(50%) scale(1.1) translateY(-5px);
            filter: drop-shadow(0 0 15px rgba(184, 134, 11, 0.6));
        }

        .pet-svg {
            width: 100%;
            height: 100%;
            /* Gradient defined in SVG defs */
        }

        /* 
        .pet-dock { ... }  <-- Removed old dock styles
        .pet-icon { ... }  <-- Removed old icon styles
        */

        .anim-bounce {
            animation: bouncePet 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .pet-bubble {
            position: absolute;
            background: #fff;
            color: #2E1A47;
            padding: 4px 12px;
            border-radius: 12px;
            font-family: 'ZCOOL QingKe HuangYou', cursive;
            font-size: 14px;
            pointer-events: none;
            opacity: 0;
            transform: translateY(10px);
            transition: all 0.3s ease;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
            z-index: 50;
            white-space: nowrap;
        }

        .pet-bubble.show {
            opacity: 1;
            transform: translateY(-20px);
        }

        .pet-bubble::after {
            content: '';
            position: absolute;
            bottom: -4px;
            left: 50%;
            transform: translateX(-50%);
            border-left: 4px solid transparent;
            border-right: 4px solid transparent;
            border-top: 4px solid #fff;
        }

        .star-particle {
            position: absolute;
            width: 10px;
            height: 10px;
            background: #C5A06B;
            clip-path: polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%);
            pointer-events: none;
            animation: particle-explode 0.8s ease-out forwards;
        }

        @keyframes particle-explode {
            0% {
                transform: translate(0, 0) scale(1) rotate(0deg);
                opacity: 1;
            }

            100% {
                transform: translate(var(--tx), var(--ty)) scale(0) rotate(180deg);
                opacity: 0;
            }
        }


        body {
            background-color: #1a0b2e;
            color: #f5f0fa;
            font-family: 'Cormorant Garamond', serif;
            overflow-x: hidden;
            height: 100vh;
            width: 100vw;
            margin: 0;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            touch-action: manipulation;
            -webkit-tap-highlight-color: transparent;
        }

        /* ═══ Dynamic Background ═══ */
        #bg-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -2;
            /* Elegant Flowing Gold Gradient (Dimmed 15%) */
            /* #FFF8DC (Cornsilk) -> #DAA520 (Goldenrod) adjusted */
            background: linear-gradient(135deg, #2E1A47 0%, #4c1d95 40%, #B0985A 80%, #9A7611 100%);
            opacity: 1;
        }

        #bg-overlay-gold {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 40%;
            z-index: -2;
            background: linear-gradient(to top, rgba(197, 160, 89, 0.08) 0%, transparent 100%);
            pointer-events: none;
        }

        #stars-layer {
            position: fixed;
            inset: 0;
            z-index: -2;
            pointer-events: none;
        }

        .star {
            position: absolute;
            background: white;
            border-radius: 50%;
            opacity: 0;
            animation: twinkle var(--duration) ease-in-out infinite;
            animation-delay: var(--delay);
        }

        @keyframes twinkle {

            0%,
            100% {
                opacity: 0.2;
                transform: scale(0.8);
            }

            50% {
                opacity: 0.9;
                transform: scale(1.2);
                box-shadow: 0 0 10px rgba(255, 255, 255, 0.8);
            }
        }

        #noise-layer {
            position: fixed;
            inset: 0;
            z-index: -1;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.05'/%3E%3C/svg%3E");
            opacity: 0.07;
            pointer-events: none;
        }

        /* ═══ Typography & Effects ═══ */
        .gold-text-gradient {
            background: linear-gradient(135deg, #E5D1A6 0%, #C5A059 40%, #FFF8E7 50%, #9C7C38 60%, #7d4ea0 100%);
            background-size: 200% auto;
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            animation: shine 6s linear infinite;
        }

        .violet-gold-splice {
            background: linear-gradient(180deg, #b088d1 0%, #C5A059 80%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 4px 12px rgba(46, 26, 71, 0.5);
            font-family: 'Pinyon Script', cursive;
        }

        @keyframes shine {
            to {
                background-position: 200% center;
            }
        }

        .text-glow {
            text-shadow: 0 0 20px rgba(197, 160, 89, 0.3);
        }

        /* ═══ Glassmorphism Cards ═══ */
        .glass-panel {
            position: relative;
            background: rgba(46, 26, 71, 0.4);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(229, 209, 166, 0.15);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            border-radius: 4px;
            transition: transform 0.3s ease-out, box-shadow 0.3s ease-out;
            transform: translateZ(0);
            /* Force GPU layer */
        }

        /* ═══ Page Transitions ═══ */
        .page {
            position: fixed;
            inset: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
            transition: opacity 0.4s ease-out, transform 0.4s ease-out;
            transform: scale(0.97);
            padding: 2rem;
            z-index: 10;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        .page.active {
            opacity: 1;
            visibility: visible;
            pointer-events: auto;
            transform: scale(1);
        }

        /* Specific alignment for result page */
        #page-result {
            justify-content: flex-start;
            padding-top: 4rem;
        }

        /* ═══ UI Components ═══ */
        .input-mag {
            background: transparent;
            border: none;
            border-bottom: 1px solid rgba(229, 209, 166, 0.3);
            color: #E5D1A6;
            font-family: 'Playfair Display', serif;
            font-size: 1.5rem;
            text-align: center;
            padding: 0.5rem 0;
            width: 100%;
            transition: border-color 0.3s ease;
            outline: none;
        }

        .input-mag:focus {
            border-bottom-color: #C5A059;
        }

        .input-mag::placeholder {
            color: rgba(229, 209, 166, 0.3);
            font-style: italic;
        }

        .btn-mag {
            position: relative;
            padding: 1rem 3rem;
            background: transparent;
            border: 1px solid rgba(197, 160, 89, 0.4);
            color: #C5A059;
            font-family: 'Cormorant Garamond', serif;
            font-size: 0.9rem;
            letter-spacing: 0.15em;
            text-transform: uppercase;
            cursor: pointer;
            overflow: hidden;
            transition: all 0.4s ease;
        }

        .btn-mag::before {
            content: '';
            position: absolute;
            inset: 0;
            background: #C5A059;
            transform: scaleX(0);
            transform-origin: right;
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: -1;
        }

        .btn-mag:hover {
            color: #1a0b2e;
            border-color: #C5A059;
        }

        .btn-mag:hover::before {
            transform: scaleX(1);
            transform-origin: left;
        }

        /* ═══ Quiz Options ═══ */
        .option-card {
            width: 100%;
            padding: 1.5rem;
            margin-bottom: 1rem;
            text-align: left;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            background: rgba(46, 26, 71, 0.4);
            border: 1px solid rgba(229, 209, 166, 0.15);
            border-radius: 4px;
            transition: background 0.15s ease-out, border-color 0.15s ease-out;
        }

        .option-card::after {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(90deg, rgba(197, 160, 89, 0), rgba(197, 160, 89, 0.1), rgba(197, 160, 89, 0));
            transform: translateX(-100%);
            transition: transform 0.4s ease-out;
        }

        /* Only apply hover on devices with a real pointer (not touchscreens) */
        @media (hover: hover) and (pointer: fine) {
            .option-card:hover {
                background: rgba(229, 209, 166, 0.08);
                border-color: rgba(197, 160, 89, 0.3);
                transform: translateY(-2px);
            }

            .option-card:hover::after {
                transform: translateX(100%);
            }
        }

        .option-card.selected {
            background: rgba(197, 160, 89, 0.15);
            border-color: #C5A059;
            box-shadow: 0 0 15px rgba(197, 160, 89, 0.15);
        }

        .option-card.selected .opt-text {
            color: #fff;
            text-shadow: 0 0 8px rgba(197, 160, 89, 0.4);
        }

        /* ═══ Progress ═══ */
        .progress-container {
            width: 100%;
            height: 2px;
            background: rgba(255, 255, 255, 0.1);
            margin-top: 2rem;
            position: relative;
        }

        .progress-bar {
            height: 100%;
            background: #C5A059;
            width: 0%;
            box-shadow: 0 0 10px #C5A059;
            transition: width 0.5s ease;
        }

        /* ═══ Animations ═══ */
        @keyframes float {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-10px);
            }
        }

        .anim-float {
            animation: float 6s ease-in-out infinite;
        }

        /* ═══ Particles Canvas ═══ */
        #particles-canvas {
            position: fixed;
            inset: 0;
            z-index: -1;
            pointer-events: none;
        }

        /* ═══ Mobile Tweaks ═══ */
        @media (max-width: 640px) {
            .magazine-title {
                font-size: 2.5rem !important;
                line-height: 1.1 !important;
            }

            .glass-panel {
                padding: 1.2rem !important;
                backdrop-filter: none !important;
                -webkit-backdrop-filter: none !important;
                background: rgba(46, 26, 71, 0.85) !important;
            }

            .page {
                padding: 0.8rem;
            }

            #page-result {
                padding-top: 1.5rem;
            }

            /* Pets: smaller on mobile */
            .pet-container {
                height: 60px;
            }

            .pet-icon-wrapper {
                width: 50px;
                height: 50px;
            }

            .pet-left {
                left: 8%;
            }

            .pet-right {
                right: 8%;
            }

            .pet-svg {
                filter: none !important;
            }

            /* Kill expensive SVG filters */

            /* Letter: fix float layout */
            .letter-paper {
                padding: 1.2rem !important;
                margin: 0 !important;
                background-image: none !important;
                /* Remove SVG noise texture */
            }

            .letter-content .float-right {
                float: none !important;
                display: block;
                width: 100px !important;
                height: 130px !important;
                margin: 0 auto 1rem auto !important;
            }

            #letterBody {
                font-size: 0.95rem !important;
                line-height: 1.7 !important;
            }

            /* Quiz */
            #qText {
                font-size: 1.15rem !important;
                line-height: 1.5 !important;
                margin-bottom: 1.5rem !important;
            }

            .option-card {
                padding: 1rem !important;
                margin-bottom: 0.6rem !important;
            }

            .option-card .opt-text {
                font-size: 0.9rem !important;
            }

            #qNum {
                font-size: 2.5rem !important;
            }

            /* Inputs & Buttons */
            .input-mag {
                font-size: 1.2rem;
            }

            .btn-mag {
                padding: 0.8rem 2rem;
                font-size: 0.85rem;
                min-height: 44px;
            }

            /* Disable expensive animations */
            .anim-float {
                animation: none !important;
            }

            .animate-sway {
                animation: none !important;
            }

            .gold-text-gradient {
                animation: none !important;
                background-size: 100% auto !important;
            }

            /* Star particles: use GPU layer */
            .star {
                will-change: opacity, transform;
            }

            /* Noise layer: remove on mobile */
            #noise-layer {
                display: none !important;
            }

            /* Hide expensive blur decoration */
            .blur-3xl {
                display: none !important;
            }

            /* Option card active state for touch */
            .option-card:active {
                background: rgba(229, 209, 166, 0.12);
                border-color: rgba(197, 160, 89, 0.4);
                transform: scale(0.98);
            }

            /* Contact modal */
            #contactModal .glass-panel {
                max-width: 85vw !important;
                padding: 1.5rem !important;
            }

            #contactModal img {
                width: 140px !important;
                height: 140px !important;
            }
        }

        /* Small phones (iPhone SE etc) */
        @media (max-width: 375px) {
            .magazine-title {
                font-size: 2rem !important;
            }

            .glass-panel {
                padding: 1rem !important;
            }

            #qText {
                font-size: 1rem !important;
            }

            .option-card .opt-text {
                font-size: 0.85rem !important;
            }
        }
    </style>
</head>

<body>

    <!-- Background Layers -->
    <div id="bg-canvas"></div>
    <div id="bg-overlay-gold"></div>
    <div id="stars-layer"></div>
    <div id="noise-layer"></div>
    <canvas id="particles-canvas"></canvas>

    <!-- ═══ Page: HOME ═══ -->
    <div id="page-home" class="page active">
        <div class="relative z-10 text-center max-w-2xl w-full">
            <div class="glass-panel p-10 md:p-16 anim-float">
                <!-- Pets (Moved to Global Dock) -->
                <p class="font-display text-xs tracking-[0.4em] uppercase text-fashion-400 mb-6">Volume I · 2026</p>
                <h1
                    class="magazine-title font-display text-6xl md:text-8xl leading-none mb-4 text-fashion-100 drop-shadow-lg">
                    <span class="gold-text-gradient italic pr-2">Inner</span><br><span
                        class="gold-text-gradient italic pr-2">Compass</span>
                </h1>
                <div class="h-px w-20 bg-gradient-to-r from-transparent via-accent-gold to-transparent mx-auto my-8">
                </div>
                <p class="font-body text-fashion-200 text-xl mb-10 tracking-wide font-light">
                    帮助我们选择<br>最适合我们自身的人格测评工具
                </p>

                <div class="max-w-xs mx-auto mb-10">
                    <input id="nameInput" type="text" placeholder="Your Name" class="input-mag" autocomplete="off">
                </div>

                <button onclick="goToCodePage()" class="btn-mag group">
                    <span>开始探索</span>
                </button>
            </div>
        </div>

        <!-- Decorative Elements -->
        <div class="absolute bottom-10 text-xs text-fashion-500 font-sans tracking-widest opacity-50">
            SCROLL TO EXPLORE
        </div>
    </div>

    <!-- ═══ Page: CODE ═══ -->
    <div id="page-code" class="page">
        <div class="glass-panel p-12 max-w-md w-full text-center">
            <!-- Pets (Moved to Global Dock) -->
            <div class="font-display text-xs tracking-[0.3em] uppercase text-accent-gold mb-8">Access Verification</div>
            <h2 class="font-body text-3xl text-fashion-100 mb-2">专属通行证</h2>
            <p class="text-fashion-400 text-sm mb-10 font-light font-body">请输入您的邀请码以解锁完整体验</p>

            <div class="relative mb-12">
                <input id="codeInput" type="text" class="input-mag text-2xl" placeholder="CODE"
                    onkeydown="if(event.key==='Enter')verifyCode()">
                <div id="codeError"
                    class="absolute -bottom-6 left-0 w-full text-xs text-red-400 opacity-0 transition-opacity font-body">
                    无效的通行证代码
                </div>
            </div>

            <button onclick="verifyCode()" class="btn-mag">验证身份</button>
        </div>
    </div>

    <!-- ═══ Page: QUIZ ═══ -->
    <div id="page-quiz" class="page">
        <div class="w-full max-w-3xl relative z-10">
            <!-- Header Info -->
            <div class="flex justify-between items-end mb-8 px-2">
                <div>
                    <span id="quizUserName" class="block font-body text-xl text-fashion-200 mb-1 italic"></span>
                    <span id="quizCategory"
                        class="font-display text-xs tracking-[0.2em] text-accent-gold uppercase"></span>
                </div>
                <div class="text-right">
                    <span id="qNum" class="font-display text-6xl text-fashion-100 leading-none">01</span>
                    <span class="text-fashion-500 text-sm font-display font-medium">/ 10</span>
                </div>
            </div>

            <!-- Question Card -->
            <div class="glass-panel p-8 md:p-12 mb-8 relative overflow-hidden">
                <!-- Pets (Moved to Global Dock) -->
                <!-- Background decoration -->
                <div class="absolute -top-10 -right-10 w-40 h-40 bg-accent-gold opacity-5 rounded-full blur-3xl"></div>

                <h3 id="qText" class="relative font-body text-2xl md:text-3xl text-fashion-5 leading-relaxed mb-10">
                </h3>

                <div id="qOptions" class="space-y-4 relative">
                    <!-- Options injected here -->
                </div>
            </div>

            <!-- Progress -->
            <div class="progress-container">
                <div id="progressFill" class="progress-bar"></div>
            </div>
        </div>
    </div>

    <!-- ═══ Page: LOADING ═══ -->
    <div id="page-loading" class="page">
        <div class="text-center relative">
            <!-- Pets (Moved to Global Dock) -->
            <div class="relative w-24 h-24 mx-auto mb-8">
                <div class="absolute inset-0 border-2 border-fashion-800 rounded-full"></div>
                <div class="absolute inset-0 border-t-2 border-accent-gold rounded-full animate-spin"></div>
                <div class="absolute inset-2 border-b-2 border-fashion-600 rounded-full animate-slow-spin"></div>
            </div>
            <p id="loadingName" class="font-display text-2xl text-fashion-100 tracking-wide mb-2"></p>
            <p class="font-sans text-xs text-fashion-500 tracking-[0.3em] uppercase">Calculating Profile</p>
        </div>
    </div>

    <!-- ═══ Page: RESULT ═══ -->
    <div id="page-result" class="page">
        <!-- SVG Defs for Pet Gradient -->
        <svg width="0" height="0" class="absolute">
            <defs>
                <linearGradient id="grad-pet" x1="0%" y1="0%" x2="100%" y2="100%">
                    <stop offset="0%" style="stop-color:#8B5CF6;stop-opacity:1" />
                    <stop offset="100%" style="stop-color:#C5A06B;stop-opacity:1" />
                </linearGradient>
            </defs>
        </svg>

        <div class="w-full max-w-4xl mx-auto pb-20 relative z-10 flex flex-col items-center">

            <!-- Toolbar -->
            <div class="w-full flex justify-end mb-4 px-4 md:px-0 max-w-2xl">
                <button onclick="downloadLetter()"
                    class="btn-mag text-xs px-6 py-2 bg-black/20 backdrop-blur hover:bg-black/40">
                    <span class="mr-2">✨</span>保存珍藏版信件
                </button>
            </div>

            <!-- The Letter (Canvas Target) -->
            <div id="letter-container" class="letter-paper w-full max-w-2xl p-8 md:p-16 mx-4 shadow-2xl relative">
                <!-- Envelope Flap -->
                <div class="envelope-flap"></div>

                <!-- Pets (Moved to Global Dock) -->

                <!-- Header -->
                <div class="text-center mb-10 border-b border-accent-gold/30 pb-6">
                    <div class="font-script text-4xl text-fashion-700 mb-2">The Inner Compass</div>
                    <div class="font-serif-cn text-xs tracking-[0.3em] text-accent-bronze uppercase">Personal Soul
                        Report</div>
                </div>

                <!-- Body -->
                <div class="letter-content text-left relative z-10">
                    <div
                        class="float-right ml-6 mb-4 w-32 h-40 border-4 border-white shadow-lg rotate-2 overflow-hidden bg-gray-100">
                        <div id="letterArt"
                            class="w-full h-full bg-cover bg-center transition-all duration-700 contrast-110 saturate-110 sepia-[.2]">
                        </div>
                    </div>

                    <div id="letterBody" class="mb-8 text-2xl md:text-3xl leading-relaxed text-[#B8860B] font-artistic drop-shadow-sm tracking-wide">
                        <!-- Content injected here -->
                    </div>
                </div>

                <!-- Footer -->
                <div class="mt-12 pt-8 text-center relative">
                    <div
                        class="absolute top-0 left-1/2 transform -translate-x-1/2 -translate-y-1/2 w-8 h-8 bg-accent-gold/20 rounded-full flex items-center justify-center">
                        <div class="w-4 h-4 bg-accent-gold rounded-full"></div>
                    </div>
                    <div class="font-script text-5xl text-fashion-800 mb-2 violet-gold-splice">Inner Wisdom</div>
                    <p class="font-serif-cn text-xs text-fashion-500 tracking-widest">Yours Truly</p>
                </div>
            </div>

            <!-- Actions -->
            <div class="mt-8 flex gap-6">
                <button onclick="showContact()"
                    class="text-fashion-300 hover:text-white transition-colors text-sm tracking-widest border-b border-transparent hover:border-white pb-1">联系主理人</button>
                <button onclick="restart()"
                    class="text-fashion-300 hover:text-white transition-colors text-sm tracking-widest border-b border-transparent hover:border-white pb-1">重新开始</button>
            </div>
        </div>
    </div>

    <!-- ═══ Contact Modal ═══ -->
    <div id="contactModal"
        class="fixed inset-0 z-50 flex items-center justify-center opacity-0 pointer-events-none transition-all duration-500 backdrop-blur-sm bg-black/60"
        onclick="hideContact(event)">
        <div class="glass-panel p-10 max-w-sm w-full text-center transform scale-95 transition-transform duration-500">
            <p class="font-display text-xs tracking-[0.2em] text-accent-gold uppercase mb-6">Connect</p>
            <div class="bg-white p-2 inline-block rounded-sm mb-6">
                <img src="新建文件夹/80aff6399ae1c0e9d222e7db56bf6dfb.jpg" alt="WeChat"
                    class="w-40 h-40 object-cover transition-all duration-500">
            </div>
            <p class="font-body text-fashion-300 text-sm mb-6">扫描二维码，开启深度对话</p>
            <button onclick="hideContact()"
                class="text-xs text-fashion-500 hover:text-white transition-colors tracking-widest font-display">CLOSE</button>
        </div>
    </div>

    <script>
        /* ═══════════════════════════════════════
           MOBILE DETECTION & PERFORMANCE CONFIG
        ═══════════════════════════════════════ */
        const isMobile = /Mobi|Android|iPhone|iPad|iPod/i.test(navigator.userAgent) || window.innerWidth < 768;
        const PERF = {
            particleCount: isMobile ? 15 : Math.min(window.innerWidth / 10, 150),
            starCount: isMobile ? 25 : 100,
            targetFPS: isMobile ? 24 : 60,
            enablePetTrail: !isMobile,
            enableShadowBlur: !isMobile,
            petTrailLength: isMobile ? 0 : 20,
        };
        const FRAME_INTERVAL = 1000 / PERF.targetFPS;

        /* ═══════════════════════════════════════
           PARTICLE SYSTEM & PET (Canvas)
        ═══════════════════════════════════════ */
        const canvas = document.getElementById('particles-canvas');
        const ctx = canvas.getContext('2d');
        let particles = [];
        let pet;
        let mouse = { x: null, y: null };

        // Debounced Resize
        let resizeTimer;
        function resize() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            if (pet) {
                pet.x = canvas.width / 2;
                pet.y = canvas.height / 2;
            }
        }
        window.addEventListener('resize', () => {
            clearTimeout(resizeTimer);
            resizeTimer = setTimeout(resize, 150);
        });

        // Mouse interaction (desktop only — no mousemove on mobile)
        if (!isMobile) {
            window.addEventListener('mousemove', (e) => {
                mouse.x = e.clientX;
                mouse.y = e.clientY;
            });
        }

        // ═══ STARS (CSS) ═══
        function initStars() {
            const starContainer = document.getElementById('stars-layer');
            starContainer.innerHTML = '';
            // Use DocumentFragment for batch DOM insert
            const frag = document.createDocumentFragment();
            for (let i = 0; i < PERF.starCount; i++) {
                const star = document.createElement('div');
                star.classList.add('star');
                const x = Math.random() * 100;
                const y = Math.random() * 100;
                const size = Math.random() * 2 + 1;
                const duration = Math.random() * 3 + 2;
                const delay = Math.random() * 5;

                star.style.cssText = `left:${x}%;top:${y}%;width:${size}px;height:${size}px;--duration:${duration}s;--delay:${delay}s`;
                frag.appendChild(star);
            }
            starContainer.appendChild(frag);
        }

        // ═══ PET ═══
        class Pet {
            constructor() {
                this.x = canvas.width / 2;
                this.y = canvas.height / 2;
                this.history = []; // For trail
                this.size = 8;
                this.color = '#B8860B'; // Deep Flowing Gold
                this.glow = 'rgba(184, 134, 11, 0.5)';
            }

            update() {
                let targetX = mouse.x || canvas.width / 2;
                let targetY = mouse.y || canvas.height / 2;
                this.x += (targetX - this.x) * 0.05;
                this.y += (targetY - this.y) * 0.05;

                if (PERF.enablePetTrail) {
                    this.history.push({ x: this.x, y: this.y, alpha: 1.0 });
                    if (this.history.length > PERF.petTrailLength) this.history.shift();
                    this.history.forEach(p => p.alpha -= 0.05);
                }
            }

            draw() {
                // Draw trail (desktop only)
                if (PERF.enablePetTrail) {
                    for (let i = 0; i < this.history.length; i++) {
                        const p = this.history[i];
                        if (p.alpha <= 0) continue;
                        ctx.beginPath();
                        ctx.arc(p.x, p.y, this.size * (i / this.history.length), 0, Math.PI * 2);
                        ctx.fillStyle = `rgba(184, 134, 11, ${p.alpha * 0.3})`;
                        ctx.fill();
                    }
                }

                // Draw body — skip expensive gradient on mobile
                if (PERF.enableShadowBlur) {
                    const grad = ctx.createRadialGradient(this.x - 2, this.y - 2, 0, this.x, this.y, this.size);
                    grad.addColorStop(0, '#FFF8E7');
                    grad.addColorStop(0.4, '#B8860B');
                    grad.addColorStop(1, '#8B4500');
                    ctx.fillStyle = grad;
                    ctx.shadowBlur = 15;
                    ctx.shadowColor = this.glow;
                } else {
                    ctx.fillStyle = this.color;
                }
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                ctx.fill();
                ctx.shadowBlur = 0;
            }
        }

        class Particle {
            constructor() {
                this.x = Math.random() * canvas.width;
                this.y = Math.random() * canvas.height;
                this.size = Math.random() * 2;
                this.speedX = (Math.random() - 0.5) * 0.5;
                this.speedY = (Math.random() - 0.5) * 0.5;
                this.life = Math.random() * 100;
                this.maxLife = 100 + Math.random() * 100;
                this.color = `rgba(184, 134, 11, ${Math.random() * 0.5})`; // Deep Gold tint
            }

            update() {
                this.x += this.speedX;
                this.y += this.speedY;
                this.life++;

                // Reset if dead or out of bounds
                if (this.life > this.maxLife ||
                    this.x < 0 || this.x > canvas.width ||
                    this.y < 0 || this.y > canvas.height) {
                    this.x = Math.random() * canvas.width;
                    this.y = Math.random() * canvas.height;
                    this.life = 0;
                }
            }

            draw() {
                ctx.fillStyle = this.color;
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                ctx.fill();
            }
        }

        function initParticles() {
            resize();
            initStars();
            pet = new Pet();

            particles = [];
            for (let i = 0; i < PERF.particleCount; i++) {
                particles.push(new Particle());
            }
        }

        let lastFrameTime = 0;
        function animateParticles(timestamp) {
            requestAnimationFrame(animateParticles);

            // Frame rate throttle for mobile
            const delta = timestamp - lastFrameTime;
            if (delta < FRAME_INTERVAL) return;
            lastFrameTime = timestamp - (delta % FRAME_INTERVAL);

            ctx.clearRect(0, 0, canvas.width, canvas.height);

            for (let i = 0; i < particles.length; i++) {
                particles[i].update();
                particles[i].draw();
            }

            if (pet) {
                pet.update();
                pet.draw();
            }
        }

        initParticles();
        requestAnimationFrame(animateParticles);


        /* ═══════════════════════════════════════
           GAME LOGIC (Preserved & Adapted)
        ═══════════════════════════════════════ */

        // Data (Same as original)
        const questions = [
            {
                category: '认知偏好', text: '当你试图理解一个人时，你最想知道的是什么？', options: [
                    { text: '他的行为偏好和决策方式', type: 'mbti' },
                    { text: '他在各个特质维度上的独特组合', type: 'bigfive' },
                    { text: '驱动他行为背后的深层动机与恐惧', type: 'enneagram' },
                    { text: '他最突出的天赋和优势领域', type: 'clifton' }
                ]
            },
            {
                category: '认知偏好', text: '你更倾向于哪种自我认知的方式？', options: [
                    { text: '通过明确的类型分类来定位自己', type: 'mbti' },
                    { text: '通过多维度的评分来精确描述自己', type: 'bigfive' },
                    { text: '通过探索内心的核心欲望来理解自己', type: 'enneagram' },
                    { text: '通过识别并发挥自己的长处来定义自己', type: 'clifton' }
                ]
            },
            {
                category: '认知偏好', text: '面对一个复杂的人际冲突，你首先会怎么做？', options: [
                    { text: '分析双方的性格类型差异', type: 'mbti' },
                    { text: '考虑各自在情绪稳定性、宜人性等维度上的不同', type: 'bigfive' },
                    { text: '探究各自的核心恐惧如何在此刻被触发', type: 'enneagram' },
                    { text: '思考如何利用各自的优势来化解僵局', type: 'clifton' }
                ]
            },
            {
                category: '认知偏好', text: '你认为「了解自己」最终应该带来什么？', options: [
                    { text: '对自我偏好的清晰认知与接纳', type: 'mbti' },
                    { text: '对自身特质的客观、科学的认识', type: 'bigfive' },
                    { text: '深刻的精神成长与自我超越', type: 'enneagram' },
                    { text: '实际的绩效提升和职业发展', type: 'clifton' }
                ]
            },
            {
                category: '认知偏好', text: '在一个理想的团队中，你认为最重要的是……', options: [
                    { text: '了解每个人的类型，实现互补协作', type: 'mbti' },
                    { text: '评估团队在各项人格特质上的分布', type: 'bigfive' },
                    { text: '理解每位成员的核心动机和压力反应', type: 'enneagram' },
                    { text: '识别并合理配置团队中每个人的优势', type: 'clifton' }
                ]
            },
            {
                category: '探索深度', text: '如果一本人格心理学书籍的开头是这样的，哪一句最吸引你？', options: [
                    { text: '"世界上有16种根本不同的看待世界的方式。"', type: 'mbti' },
                    { text: '"人格可以被精确地分解为五个独立的维度。"', type: 'bigfive' },
                    { text: '"每个人内心深处都有一个被遗忘的童年渴望。"', type: 'enneagram' },
                    { text: '"投资你的优势，回报率将是无限的。"', type: 'clifton' }
                ]
            },
            {
                category: '探索深度', text: '你对「人能否被改变」这个问题怎么看？', options: [
                    { text: '核心偏好是天生的，但表达方式可以成熟', type: 'mbti' },
                    { text: '特质在一定范围内是可以变化和发展的', type: 'bigfive' },
                    { text: '人可以通过意识觉醒实现根本性的内在转化', type: 'enneagram' },
                    { text: '与其修补弱点，不如将天赋磨练成优势', type: 'clifton' }
                ]
            },
            {
                category: '探索深度', text: '你更喜欢哪种关于自我的解读方式？', options: [
                    { text: '简洁的类型标签，如"INFP——调停者"', type: 'mbti' },
                    { text: '详细的数据图表和百分位数报告', type: 'bigfive' },
                    { text: '深入的叙事描写和成长路径指引', type: 'enneagram' },
                    { text: '聚焦实操的才干排名和行动建议', type: 'clifton' }
                ]
            },
            {
                category: '探索深度', text: '在选择职业方向时，你更看重什么？', options: [
                    { text: '这份工作是否与我的性格类型相契合', type: 'mbti' },
                    { text: '客观评估我的特质是否匹配岗位要求', type: 'bigfive' },
                    { text: '这份工作是否能满足我灵魂深处的渴求', type: 'enneagram' },
                    { text: '这份工作是否能让我每天运用最擅长的事', type: 'clifton' }
                ]
            },
            {
                category: '探索深度', text: '你如何看待人格测评的「科学性」？', options: [
                    { text: '理论框架清晰、便于实际应用就好', type: 'mbti' },
                    { text: '必须有严谨的学术研究和数据支撑', type: 'bigfive' },
                    { text: '真正的洞见超越了传统科学的范畴', type: 'enneagram' },
                    { text: '能否带来切实的行为改变才是关键', type: 'clifton' }
                ]
            }
        ];

        const results = {
            mbti: {
                label: 'Personality Type Indicator',
                title: 'MBTI',
                titleCN: '迈尔斯-布里格斯类型指标',
                subtitle: 'The Cognitive Prism',
                art: 'url("https://images.unsplash.com/photo-1550684848-fac1c5b4e853?q=80&w=800&auto=format&fit=crop")', // Retro Prism
                getDesc: (name) => `亲爱的 <span class="text-3xl text-accent-gold font-script text-glow ml-1 mr-1">${name}</span>，\n\n你拥有一种清晰而敏锐的认知方式。你天然地倾向于通过类型化的框架来理解这个纷繁复杂的世界——你相信，人与人之间存在着根本性的认知差异，而理解这些差异是一切沟通与协作的基石。\n\nMBTI 将为你提供一面精准的认知棱镜。通过四个核心维度——外向与内向、感觉与直觉、思维与情感、判断与知觉——为你勾勒出属于你的十六型人格画像。\n\n真正的智慧在于——看见差异、尊重差异、善用差异。`
            },
            bigfive: {
                label: 'Five-Factor Model',
                title: 'Big Five',
                titleCN: '大五人格模型',
                subtitle: 'The Precision Map',
                art: 'url("https://images.unsplash.com/photo-1524661135-423995f22d0b?q=80&w=800&auto=format&fit=crop")', // Abstract Map
                getDesc: (name) => `亲爱的 <span class="text-3xl text-accent-gold font-script text-glow ml-1 mr-1">${name}</span>，\n\n你是一个追求精确与客观的人。你不满足于简单的标签——你渴望的是一张关于自我的高清地图，每一处地形都经得起反复测量与验证。\n\n大五人格模型（OCEAN）是当今心理学界最受学术认可的人格理论。它通过五个独立的特质维度——开放性、尽责性、外向性、宜人性、神经质——为你绘制一幅精密的人格雷达图。\n\n你的每一个特质都落在一条连续的光谱上，这意味着你的人格画像是独一无二的。用数据之光照亮你内在的每一个角落。`
            },
            enneagram: {
                label: 'Ancient Wisdom System',
                title: 'Enneagram',
                titleCN: '九型人格',
                subtitle: 'The Inner Spiral',
                art: 'url("https://images.unsplash.com/photo-1464802686167-b939a6910659?q=80&w=800&auto=format&fit=crop")', // Galaxy Spiral
                getDesc: (name) => `亲爱的 <span class="text-3xl text-accent-gold font-script text-glow ml-1 mr-1">${name}</span>，\n\n你是一个灵魂的深潜者。对你而言，自我认知不是一张浅层的标签，而是一场通往内心最深处的旅程。你想知道的不仅仅是「我是什么样的人」，更是「我为什么会成为这样的人」。\n\n九型人格（Enneagram）直指你内心最核心的动机、最深层的恐惧、以及最本真的渴望。\n\n在九型人格的地图上，每一种类型都有其独特的成长路径——从执念到自由，从恐惧到觉醒。这条螺旋上升的道路，正是你灵魂一直在寻找的。`
            },
            clifton: {
                label: 'Strengths-Based Development',
                title: 'CliftonStrengths',
                titleCN: '克利夫顿优势识别',
                subtitle: 'The Strength Compass',
                art: 'url("https://images.unsplash.com/photo-1516541196182-6bdb0516ed27?q=80&w=800&auto=format&fit=crop")', // Antique Compass
                getDesc: (name) => `亲爱的 <span class="text-3xl text-accent-gold font-script text-glow ml-1 mr-1">${name}</span>，\n\n你是一个天生的行动派。你相信，认识自我的终极目的不是分析，而是行动——是将你的天赋磨练成真实的、可以改变世界的优势。\n\n克利夫顿优势识别（CliftonStrengths）将识别出你最突出的才干主题。它不会让你纠结于弱点的修补，而是帮你将目光聚焦于最有力量的地方。\n\n你的优势就是你的指南针。现在，让我们一起找到它。`
            }
        };

        // State
        let userName = '';
        let currentQ = 0;
        let scores = { mbti: 0, bigfive: 0, enneagram: 0, clifton: 0 };

        // Navigation
        // History Support
        window.addEventListener('popstate', (event) => {
            const pageId = event.state ? event.state.page : 'page-home';
            showPage(pageId, false);
        });

        function showPage(id, pushToHistory = true) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            const target = document.getElementById(id);
            if (target) target.classList.add('active');

            // ═══ Pet Display: Only show on Home page ═══
            const petContainer = document.querySelector('.pet-container');
            if (petContainer) {
                if (id === 'page-home') {
                    petContainer.classList.remove('hide-pets');
                } else {
                    petContainer.classList.add('hide-pets');
                }
            }

            // ═══ Pause/Resume canvas animation on quiz pages for perf ═══
            if (isMobile) {
                if (id === 'page-quiz' || id === 'page-code' || id === 'page-loading') {
                    canvas.style.display = 'none';
                } else {
                    canvas.style.display = '';
                }
            }

            // Update History
            if (pushToHistory) {
                history.pushState({ page: id }, '', '#' + id);
            }
        }

        function goToCodePage() {
            const nameInput = document.getElementById('nameInput');
            const name = nameInput.value.trim();
            if (!name) {
                nameInput.classList.add('border-red-500');
                nameInput.placeholder = "REQUIRED";
                setTimeout(() => nameInput.classList.remove('border-red-500'), 1000);
                return;
            }
            userName = name;
            showPage('page-code');
            setTimeout(() => document.getElementById('codeInput').focus(), 500);
        }

        function verifyCode() {
            const codeInput = document.getElementById('codeInput');
            const code = codeInput.value.trim();
            const errEl = document.getElementById('codeError');

            if (code === '6688') {
                errEl.style.opacity = '0';
                startQuiz();
            } else {
                errEl.style.opacity = '1';
                codeInput.classList.add('border-red-500');
                setTimeout(() => codeInput.classList.remove('border-red-500'), 1000);
            }
        }

        function startQuiz() {
            currentQ = 0;
            scores = { mbti: 0, bigfive: 0, enneagram: 0, clifton: 0 };
            showPage('page-quiz');
            document.getElementById('quizUserName').innerHTML = `亲爱的 <span class="text-accent-gold text-2xl font-bold ml-2 text-glow">${userName}</span>`;
            renderQuestion();
        }

        function renderQuestion() {
            const q = questions[currentQ];
            document.getElementById('qNum').textContent = String(currentQ + 1).padStart(2, '0');
            document.getElementById('qText').textContent = q.text;
            document.getElementById('quizCategory').textContent = q.category;

            const optContainer = document.getElementById('qOptions');
            const letters = ['A', 'B', 'C', 'D'];

            optContainer.innerHTML = q.options.map((opt, i) => `
                <div class="option-card" onclick="selectAnswer('${opt.type}', this)">
                    <span class="font-display font-bold text-accent-gold mr-4 text-lg">${letters[i]}</span>
                    <span class="opt-text font-serif-cn text-fashion-200">${opt.text}</span>
                </div>
            `).join('');

            // Progress
            const pct = (currentQ / questions.length) * 100;
            document.getElementById('progressFill').style.width = pct + '%';
        }

        function selectAnswer(type, card) {
            if (card.classList.contains('selected')) return;

            // Lock all cards immediately
            const allCards = document.querySelectorAll('.option-card');
            allCards.forEach(c => c.style.pointerEvents = 'none');
            card.classList.add('selected');

            scores[type]++;

            setTimeout(() => {
                currentQ++;
                if (currentQ < questions.length) {
                    renderQuestion();
                } else {
                    document.getElementById('progressFill').style.width = '100%';
                    showLoading();
                }
            }, 400);
        }

        function showLoading() {
            showPage('page-loading');
            document.getElementById('loadingName').innerHTML = `亲爱的 <span class="text-3xl text-accent-gold font-script text-glow">${userName}</span>`;
            setTimeout(showResult, 2500);
        }

        function showResult() {
            const winner = Object.entries(scores).sort((a, b) => b[1] - a[1])[0][0];
            const r = results[winner];

            // Construct Letter Content
            const content = `
                <div class="mb-4 font-bold text-fashion-800 text-xl">${r.titleCN} <span class="text-sm font-normal text-fashion-500">(${r.title})</span></div>
                <div class="mb-6 italic text-fashion-600 border-l-2 border-accent-gold pl-4">${r.subtitle}</div>
                ${r.getDesc(userName).replace(/\n/g, '<br>')}
            `;

            document.getElementById('letterBody').innerHTML = content;

            // Set Art Background
            const artEl = document.getElementById('letterArt');
            artEl.style.backgroundImage = r.art;

            showPage('page-result');
        }

        // Lazy-load html2canvas on demand
        let html2canvasLoaded = false;
        function loadHtml2Canvas() {
            return new Promise((resolve, reject) => {
                if (html2canvasLoaded) { resolve(); return; }
                const s = document.createElement('script');
                s.src = 'https://html2canvas.hertzen.com/dist/html2canvas.min.js';
                s.onload = () => { html2canvasLoaded = true; resolve(); };
                s.onerror = reject;
                document.head.appendChild(s);
            });
        }

        function downloadLetter() {
            const element = document.getElementById('letter-container');
            const btn = document.querySelector('button[onclick="downloadLetter()"]');

            btn.innerHTML = '加载中...';

            loadHtml2Canvas().then(() => {
                btn.innerHTML = '生成中...';
                html2canvas(element, {
                    scale: isMobile ? 2 : 3,
                    useCORS: true,
                    backgroundColor: null,
                    logging: false
                }).then(canvas => {
                    const link = document.createElement('a');
                    link.download = `InnerCompass_Letter_${userName}.png`;
                    link.href = canvas.toDataURL('image/png', 1.0);
                    link.click();
                    btn.innerHTML = '<span class="mr-2">✨</span>保存珍藏版信件';
                });
            }).catch(() => {
                btn.innerHTML = '加载失败，请重试';
            });
        }

        function showContact() {
            const modal = document.getElementById('contactModal');
            modal.classList.remove('opacity-0', 'pointer-events-none');
            modal.querySelector('div').classList.remove('scale-95');
            modal.querySelector('div').classList.add('scale-100');
        }

        function hideContact(e) {
            if (e && e.target !== e.currentTarget) return;
            const modal = document.getElementById('contactModal');
            modal.classList.add('opacity-0', 'pointer-events-none');
            modal.querySelector('div').classList.remove('scale-100');
            modal.querySelector('div').classList.add('scale-95');
        }

        // ═══ Pet Interaction ═══
        function petInteract(el, e) {
            e.stopPropagation();

            // 1. Bounce Animation
            el.classList.remove('anim-bounce');
            void el.offsetWidth; // Trigger reflow
            el.classList.add('anim-bounce');

            // 2. Bubble Dialog
            showBubble(el, "你好呀");

            // 3. Particles
            spawnParticles(e.clientX, e.clientY);
        }

        function showBubble(targetEl, text) {
            // Remove existing bubble for this element if any
            let existing = targetEl.parentElement.querySelector('.pet-bubble-instance-' + targetEl.classList[1]);
            if (existing) existing.remove();

            const bubble = document.createElement('div');
            bubble.className = `pet-bubble pet-bubble-instance-${targetEl.classList[1]}`;
            bubble.textContent = text;

            // Position
            const rect = targetEl.getBoundingClientRect();
            const containerRect = targetEl.parentElement.getBoundingClientRect();

            // Calculate relative position
            bubble.style.left = (rect.left - containerRect.left + rect.width / 2 - 30) + 'px';
            bubble.style.top = (rect.top - containerRect.top - 40) + 'px';

            targetEl.parentElement.appendChild(bubble);

            // Animate in
            requestAnimationFrame(() => bubble.classList.add('show'));

            // Remove after 2s
            setTimeout(() => {
                bubble.classList.remove('show');
                setTimeout(() => bubble.remove(), 300);
            }, 2000);
        }

        function spawnParticles(x, y) {
            const count = 8;
            for (let i = 0; i < count; i++) {
                const p = document.createElement('div');
                p.classList.add('star-particle');

                // Random angle and distance
                const angle = (Math.PI * 2 * i) / count;
                const dist = 50 + Math.random() * 30;
                const tx = Math.cos(angle) * dist + 'px';
                const ty = Math.sin(angle) * dist + 'px';

                p.style.setProperty('--tx', tx);
                p.style.setProperty('--ty', ty);
                p.style.left = x + 'px';
                p.style.top = y + 'px';

                document.body.appendChild(p);

                setTimeout(() => p.remove(), 800);
            }
        }

        function restart() {
            document.getElementById('nameInput').value = '';
            showPage('page-home');
        }
    </script>
</body>

</html>